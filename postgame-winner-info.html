<!DOCTYPE html>
<html>
	<head>
		<script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
		<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
		<script src="airtable.browser.js"></script>
		<script src="settings.js"></script>
		<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
	</head>
	<body>
		<button id='refreshPlayerlist'>Force-Refresh Playerlist</button>
		<button id='clearAll'>Clear</button>
		<h1>Race Selection</h1>
		<div id='season'></div>
		<div id='week'></div>
		<div id='race'><label for='raceInput'>Race: </label><input type='number' id='raceInput' min='1' size='4'> <button id='nextRace'>Next Race</button></div>

		<h1>Top 3</h1>
		<div class="ui-widget">
			<label for="player1">1st Place</label>
			<input id="player1" class="playerName">
		</div>
		<div class="ui-widget">
			<label for="player2">2nd Place</label>
			<input id="player2" class="playerName">
		</div>
		<div class="ui-widget">
			<label for="player3">3rd Place</label>
			<input id="player3" class="playerName">
		</div>

		<hr/>
		
		<div id="announcerCopyplayer1" class="announcerCopy"></div>
		<div id="announcerCopyplayer2" class="announcerCopy"></div>
		<div id="announcerCopyplayer3" class="announcerCopy"></div>

		<div id="created"></div>
	</body>


<script>
var Airtable = require('airtable');
// Setup which base we are connecting to and the API key to authenticate. These are pulled in from settings.js
var airtableDB = new Airtable({apiKey: config.airtable.apiKey}).base(config.airtable.baseID);

// playerList holds cache of player names pulled from Airtable
var playerList = {}
var playerAutoComplete = []

// loadPlayers updates the cache of player names from Airtable to ensure its up-to-date
var loadPlayers = function() {
	//$('#players').empty();
	
	playerList = {}

	// Pull data from the "Players" table
	airtableDB(config.airtable.playerTableName).select({
		sort: [
			// Sort by PlayerName in ascending order
			{field: config.airtable.playerFieldName, direction: 'asc'}
		]
	}).eachPage(function page(records, fetchNextPage) {
		records.forEach(function(record) {
			// Pull the "PlayerName" column for each player - this will be the lookup key used in the player list
			var playerName = record.get(config.airtable.playerFieldName)

			// And add each player to the Playerlist with the relevant attributes
			playerList[playerName] = {}
			playerList[playerName].recordID = record.getId()

			// Loop over all fields from Airtable, grab the value and shove it into the playerList object
			Object.keys(record.fields).forEach(fieldName => {
				playerList[playerName][fieldName] = record.fields[fieldName]
			});

		});
		// If there are more than 100 results, AirTables paginates the output into multiple chunks
		fetchNextPage();
	}, function done(error) {
		if(error) console.log(error);

		// Refresh the auto-complete fields with the new data
		updateAutocomplete()
	});
};


// playerList holds cache of player names pulled from Airtable
var raceList = {}

// loadRaces updates the cache of Race result data from Airtable to ensure its up-to-date
var loadRaces = function(firstRun=false) {
	
	raceList = {}

	// Pull data from the "Races" table for this week
	airtableDB(config.airtable.raceTableName).select({
		filterByFormula: `AND(Season="${config.lfg.season}", Week="${config.lfg.week}")`,
	}).eachPage(function page(records, fetchNextPage) {
		records.forEach(function(record) {
			// Pull the "PlayerName" column for each player - this will be the lookup key used in the player list
			var recordID = record.getId()

			// And add each race to the Playerlist with the relevant attributes
			raceList[recordID] = {}
			
			// Loop over all fields from Airtable, grab the value and shove it into the raceList object
			Object.keys(record.fields).forEach(fieldName => {
				raceList[recordID][fieldName] = record.fields[fieldName]
			});

		});
		// If there are more than 100 results, AirTables paginates the output into multiple chunks
		fetchNextPage();
	}, function done(error) {
		if(error) console.log(error);

		// The first time we pull data, update the race number to be the next available number
		if (firstRun){
			$('#raceInput').val(getLastUnfilledRace()+1)
		}

	});
};

// Any field with "class=playerName" will be setup with autocomplete using the current playerlist data
function updateAutocomplete(){
	$('.playerName').autocomplete({
      source: Object.keys(playerList)
	});
}

// Setup action when refresh button is clicked to manually pull fresh data from airtable
$('#refreshPlayerlist').click(function(){
	loadPlayers()
})

$('#clearAll').click(function(){
	$('.playerName').val("")
	$('.announcerCopy').empty();
})

// Tool for adding proper suffixes to numbers for 1st, 2nd, 3rd, 4th, etc
const english_ordinal_rules = new Intl.PluralRules("en", {type: "ordinal"});
const suffixes = {
    one: "st",
    two: "nd",
    few: "rd",
    other: "th"
};
function ordinal(number) {
    const suffix = suffixes[english_ordinal_rules.select(number)];
    return suffix;
}


function calcNthPlaceFinishesTonight(playerName, nthPlace) {
	// Map player name to record ID, since this is what is seen in Race table data
	var playerID = playerList[playerName].recordID

	// Use the appropriate field name based on which place we're looking at (1st, 2nd, 3rd, etc)
	var fieldName = config.airtable.raceFieldNamePlace[nthPlace]

	var resultCount = 0

	// Loop over all races and check for the playerID in the results
	Object.keys(raceList).forEach(race => {
		// If the player ID matches the race result field, increment the counter
		if(raceList[race][fieldName] == playerID){
			resultCount++;
		}

	});

	return resultCount;
}

// This function will count how many times a player played in the top N places (e.g. 1st through 5th)
function calcTopFinishesTonight(playerName, nthPlace) {
	var resultCount = 0

	for(i=1; i<=nthPlace; i++){
		resultCount += calcNthPlaceFinishesTonight(playerName,i)
	}

	return resultCount;
}


$('.playerName').change(function(){
	// Setup clearer mapping of player name based on which field was changed
	var playerName = this.value
	// fieldLabel will have the text of whatever label is attached to this field (e.g. "1st Place")
	var fieldLabel = this.labels[0].outerText

	// Since the data we pulled is from before the end of this race, need to always add "1" to any win counter

	// Construct the output text/html
	var copyText = $('<div>');
	
	// Text blurb varies depending on which placement this is for
	if (this.id == 'player1'){
		// Count only 1st place placements (wins)
		var firstPlaceWins = calcNthPlaceFinishesTonight(playerName,1) + 1
		var firstPlacePoints = playerList[playerName][config.airtable.playerPointsFieldName] + config.lfg.pointsForPlace[1]

		copyText.append(`<b><u>First place</u></b>: <b>${playerName}</b>. `)
		if(firstPlaceWins==1){
			copyText.append(`This is their <b>${firstPlaceWins}${ordinal(firstPlaceWins)}</b> first place finish tonight `)
		}
		else{
			copyText.append(`They've gotten <b>${firstPlaceWins}</b> first place finishes tonight `)
		}
		copyText.append(`and racked up <b>${firstPlacePoints}</b> big points. `)
		//copyText.append(`They're now ranked ${""}.`)
	}
	else if (this.id == 'player2'){
		// Count all top-5 placements
		var secondPlaceTopPlacements = calcTopFinishesTonight(playerName,5) + 1
		var secondPlacePoints = playerList[playerName][config.airtable.playerPointsFieldName] + config.lfg.pointsForPlace[2]

		copyText.append(`<b><u>Second place</u></b>: <b>${playerName}</b>. `)
		copyText.append(`This is their <b>${secondPlaceTopPlacements}${ordinal(secondPlaceTopPlacements)}</b> time placing in the big five `)
		copyText.append(`and they've got <b>${secondPlacePoints}</b> points now. `)
		//copyText.append(`They're now ranked ${""}.`)
	}
	else if (this.id == 'player3'){
		// Count all top-5 placements
		var thirdPlaceTopPlacements = calcTopFinishesTonight(playerName,5) + 1
		var thirdPlacePoints = playerList[playerName][config.airtable.playerPointsFieldName] + config.lfg.pointsForPlace[3]

		copyText.append(`<b><u>Third place</u></b>: <b>${playerName}</b>. `)
		if(thirdPlaceTopPlacements==1){
			copyText.append(`This is their <b>${thirdPlaceTopPlacements}${ordinal(thirdPlaceTopPlacements)}</b> time making the big five `)
		}
		else{
			copyText.append(`They've made the big five <b>${thirdPlaceTopPlacements}</b> times now `)
		}
		copyText.append(`and are up to <b>${thirdPlacePoints}</b> points. `)
		//copyText.append(`They're now ranked ${""}.`)
	}

	// Make the output show up in the appropriate section of the page (announcerCopy<fieldID>)
	$('#announcerCopy'+this.id).empty();
	$('#announcerCopy'+this.id).append(copyText);
})


$('#nextRace').click(function(){
	document.getElementById('raceInput').value++
})

function getLastUnfilledRace(){
	var highestRace = 1
	
	Object.keys(raceList).forEach(race => {
		// If the player ID matches the race result field, increment the counter
		if(parseInt(raceList[race].Race) > highestRace){
			highestRace=parseInt(raceList[race].Race);
		}
	})

	return highestRace;
}


// Setup data refresh from Airtable every 15 seconds with an immediate refresh to start
loadPlayers()
var airtablePlayerRefreshTimer = setInterval(loadPlayers, 15000);

loadRaces(true)
var airtableRaceRefreshTimer = setInterval(loadRaces, 30000);

$('#season').append(`Season: ${config.lfg.season}`)
$('#week').append(`Week: ${config.lfg.week}`)


</script>


</html>