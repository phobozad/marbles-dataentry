<!DOCTYPE html>
<html>
	<head>
		<script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
		<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
		<script src="airtable.browser.js"></script>
		<script src="../settings.js"></script>
		<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
	</head>
	<body>
		<button id='refreshPlayerlist'>Force-Refresh Playerlist</button>
		<button id='clearTop3'>Clear Top 3</button>
		<h1>Race Selection</h1>
		<div id='season'></div>
		<div id='week'></div>
		<div id='race'><label for='raceInput'>Race:</label><input type='number' id='raceInput' min='1' size='4'> <button id='nextRace'>Next Race & Clear All</button></div>
		<form id='rawResultsForm' action='javascript:;' onsubmit='saveRaceRaw()'>
		<div id='location' class='ui-widget'>
			<label for='raceLocation'>Track:</label>
			<input id='raceLocation'>
		</div>

		<h1>Top 3</h1>
		<div class="ui-widget">
			<label for="player1">1st Place</label>
			<input id="player1" class="playerName">
		</div>
		<div class="ui-widget">
			<label for="player2">2nd Place</label>
			<input id="player2" class="playerName">
		</div>
		<div class="ui-widget">
			<label for="player3">3rd Place</label>
			<input id="player3" class="playerName">
		</div>

		<hr/>
		
		<div id="announcerCopyplayer1" class="announcerCopy"></div>
		<div id="announcerCopyplayer2" class="announcerCopy"></div>
		<div id="announcerCopyplayer3" class="announcerCopy"></div>

		<hr/>

		<div>
			<label for='lastPlaceInput'>Last Finisher:</label><input id='lastPlaceInput' type='number' min='0' required> <button id='saveOrderedRaceResults'>Save race placements</button>
			<br><br>
			<textarea id='orderedRaceResults' cols='30' rows='25' required></textarea>
		</div>
		</form>

	</body>


<script>
var Airtable = require('airtable');
// Setup which base we are connecting to and the API key to authenticate. These are pulled in from settings.js
var airtableDB = new Airtable({apiKey: config.airtable.apiKey}).base(config.airtable.baseID);

// playerList holds cache of player names pulled from Airtable
var playerList = {}

// loadPlayers updates the cache of player names from Airtable to ensure its up-to-date
var loadPlayers = function() {
	//$('#players').empty();
	
	playerList = {}

	// Pull data from the "Players" table
	airtableDB(config.airtable.playerTableName).select({
		sort: [
			// Sort by PlayerName in ascending order
			{field: config.airtable.playerFieldName, direction: 'asc'}
		]
	}).eachPage(function page(records, fetchNextPage) {
		records.forEach(function(record) {
			// Pull the "PlayerName" column for each player - this will be the lookup key used in the player list
			var playerName = record.get(config.airtable.playerFieldName)

			// And add each player to the Playerlist with the relevant attributes
			playerList[playerName] = {}
			playerList[playerName].recordID = record.getId()

			// Loop over all fields from Airtable, grab the value and shove it into the playerList object
			Object.keys(record.fields).forEach(fieldName => {
				playerList[playerName][fieldName] = record.fields[fieldName]
			});

		});
		// If there are more than 100 results, AirTables paginates the output into multiple chunks
		fetchNextPage();
	}, function done(error) {
		if(error) console.log(error);

		// Refresh the auto-complete fields with the new data
		updatePlayerAutocomplete()
	});
};


// playerList holds cache of player names pulled from Airtable
var raceList = {}

// loadRaces updates the cache of Race result data from Airtable to ensure its up-to-date
var loadRaces = function(firstRun=false) {
	
	raceList = {}

	// Pull data from the "Races" table for this week
	airtableDB(config.airtable.raceTableName).select({
		filterByFormula: `AND(Season="${config.lfg.season}", Week="${config.lfg.week}")`,
	}).eachPage(function page(records, fetchNextPage) {
		records.forEach(function(record) {
			// Pull the Airtable record ID for each reace - this will be the lookup key used in the race list
			var recordID = record.getId()

			// And add each race to the Playerlist with the relevant attributes
			raceList[recordID] = {}
			
			// Loop over all fields from Airtable, grab the value and shove it into the raceList object
			Object.keys(record.fields).forEach(fieldName => {
				raceList[recordID][fieldName] = record.fields[fieldName]
			});

		});
		// If there are more than 100 results, AirTables paginates the output into multiple chunks
		fetchNextPage();
	}, function done(error) {
		if(error) console.log(error);

		// The first time we pull data, update the race number to be the next available number
		if (firstRun){
			$('#raceInput').val(getLastUnfilledRace()+1).change()
		}

		// If there is new race data, we may not need to provide the location info now, so update the required attribute
		updateLocationRequiredAttr()
	});
};


// locationList holds cache of maps pulled from Airtable
var locationList = {}

// loadLocations updates the cache of maps names from Airtable
var loadLocations = function() {	
	locationList = {}

	// Pull data from the "Locations" table
	airtableDB(config.airtable.locationTableName).select({
		sort: [
			// Sort by Name in ascending order
			{field: config.airtable.locationNameField, direction: 'asc'}
		]
	}).eachPage(function page(records, fetchNextPage) {
		records.forEach(function(record) {
			// Pull the "Name" column for each location - this will be the lookup key used in the location list
			var locationName = record.get(config.airtable.locationNameField)

			// And add each player to the locationList with the relevant attributes
			locationList[locationName] = {}
			locationList[locationName].recordID = record.getId()

			// Loop over all fields from Airtable, grab the value and shove it into the object
			Object.keys(record.fields).forEach(fieldName => {
				locationList[locationName][fieldName] = record.fields[fieldName]
			});

		});
		// If there are more than 100 results, AirTables paginates the output into multiple chunks
		fetchNextPage();
	}, function done(error) {
		if(error) console.log(error);

		// Refresh the auto-complete fields with the new data
		updateLocationAutocomplete()
	});
};

// Any field with "class=playerName" will be setup with autocomplete using the current playerlist data
function updatePlayerAutocomplete(){
	$('.playerName').autocomplete({
	  source: Object.keys(playerList)
	});
}

function updateLocationAutocomplete() {
	$('#raceLocation').autocomplete({
		source: Object.keys(locationList)
	})
}

// Setup action when refresh button is clicked to manually pull fresh data from airtable
$('#refreshPlayerlist').click(function(){
	loadPlayers()
})

$('#clearTop3').click(function(){
	$('.playerName').val("")
	$('.announcerCopy').empty();
})

// Tool for adding proper suffixes to numbers for 1st, 2nd, 3rd, 4th, etc
const english_ordinal_rules = new Intl.PluralRules("en", {type: "ordinal"});
const suffixes = {
	one: "st",
	two: "nd",
	few: "rd",
	other: "th"
};
function ordinal(number) {
	const suffix = suffixes[english_ordinal_rules.select(number)];
	return suffix;
}


function calcNthPlaceFinishesTonight(playerName, nthPlace) {
	// Map player name to record ID, since this is what is seen in Race table data
	try{
		var playerID = playerList[playerName].recordID
	}
	catch(e){
		console.error(`Player ${playerName} not found in database`)
		return false
	}

	// Use the appropriate field name based on which place we're looking at (1st, 2nd, 3rd, etc)
	var fieldName = config.airtable.raceFieldNamePlace[nthPlace]

	var resultCount = 0

	// Loop over all races and check for the playerID in the results
	Object.keys(raceList).forEach(race => {
		// If the player ID matches the race result field, increment the counter
		if(raceList[race][fieldName] == playerID){
			resultCount++;
		}

	});

	return resultCount;
}

// This function will count how many times a player played in the top N places (e.g. 1st through 5th)
function calcTopFinishesTonight(playerName, nthPlace) {
	var resultCount = 0

	for(var i=1; i<=nthPlace; i++){
		resultCount += calcNthPlaceFinishesTonight(playerName,i)
	}

	return resultCount;
}


$('.playerName').change(function(){
	// Setup clearer mapping of player name based on which field was changed
	var playerName = this.value
	// fieldLabel will have the text of whatever label is attached to this field (e.g. "1st Place")
	var fieldLabel = this.labels[0].outerText

	// Skip blank data since we'll error out anyway
	if (playerName == "") return;
	if (!(playerName in playerList)){
		console.error(`Player ${playerName} not found in database`)
		return
	}

	// Since the data we pulled is from before the end of this race, need to always add "1" to any win counter

	// Construct the output text/html
	var copyText = $('<div>');
	
	// Text blurb varies depending on which placement this is for
	if (this.id == 'player1'){
		// Count only 1st place placements (wins)
		var firstPlaceWins = calcNthPlaceFinishesTonight(playerName,1) + 1
		var firstPlacePoints = playerList[playerName][config.airtable.playerPointsFieldName] + config.lfg.pointsForPlace[1]

		copyText.append(`<b><u>First place</u></b>: <b>${playerName}</b>. `)
		if(firstPlaceWins==1){
			copyText.append(`This is their <b>${firstPlaceWins}${ordinal(firstPlaceWins)}</b> first place finish tonight `)
		}
		else{
			copyText.append(`They've gotten <b>${firstPlaceWins}</b> first place finishes tonight `)
		}
		copyText.append(`and racked up <b>${firstPlacePoints}</b> big points. `)
		//copyText.append(`They're now ranked ${""}.`)
	}
	else if (this.id == 'player2'){
		// Count all top-5 placements
		var secondPlaceTopPlacements = calcTopFinishesTonight(playerName,5) + 1
		var secondPlacePoints = playerList[playerName][config.airtable.playerPointsFieldName] + config.lfg.pointsForPlace[2]

		copyText.append(`<b><u>Second place</u></b>: <b>${playerName}</b>. `)
		copyText.append(`This is their <b>${secondPlaceTopPlacements}${ordinal(secondPlaceTopPlacements)}</b> time placing in the big five `)
		copyText.append(`and they've got <b>${secondPlacePoints}</b> points now. `)
		//copyText.append(`They're now ranked ${""}.`)
	}
	else if (this.id == 'player3'){
		// Count all top-5 placements
		var thirdPlaceTopPlacements = calcTopFinishesTonight(playerName,5) + 1
		var thirdPlacePoints = playerList[playerName][config.airtable.playerPointsFieldName] + config.lfg.pointsForPlace[3]

		copyText.append(`<b><u>Third place</u></b>: <b>${playerName}</b>. `)
		if(thirdPlaceTopPlacements==1){
			copyText.append(`This is their <b>${thirdPlaceTopPlacements}${ordinal(thirdPlaceTopPlacements)}</b> time making the big five `)
		}
		else{
			copyText.append(`They've made the big five <b>${thirdPlaceTopPlacements}</b> times now `)
		}
		copyText.append(`and are up to <b>${thirdPlacePoints}</b> points. `)
		//copyText.append(`They're now ranked ${""}.`)
	}

	// Make the output show up in the appropriate section of the page (announcerCopy<fieldID>)
	$('#announcerCopy'+this.id).empty();
	$('#announcerCopy'+this.id).append(copyText);
})

// Mark location field as required if this is a new map
function updateLocationRequiredAttr(){
	if (checkRaceExists($('#raceInput').val())===false){
		$('#raceLocation').attr('required', true)
	}
	else{
		$('#raceLocation').removeAttr('required')
	}
}

$('#raceInput').change(function raceInputChange(){
	updateLocationRequiredAttr()
})



$('#nextRace').click(function(){
	document.getElementById('raceInput').value++
	$('#raceInput').change()

	clearAllFields()
})

// Function to clear all fields except race number
function clearAllFields(){
	$('.playerName').val("").change()
	$('.announcerCopy').empty();
	$('#lastPlaceInput').val("").change()
	$('#orderedRaceResults').val("").change()
	$('#raceLocation').val("").change()
	
}

function getLastUnfilledRace(){
	var highestRace = 0
	
	Object.keys(raceList).forEach(race => {
		// If the player ID matches the race result field, increment the counter
		if(parseInt(raceList[race][config.airtable.raceNumberFieldName]) > highestRace){
			highestRace=parseInt(raceList[race][config.airtable.raceNumberFieldName]);
		}
	})

	return highestRace;
}

// Auto-populate Top 3 fields when the full race results are pasted in
$('#orderedRaceResults').change(function(){
	
	// Clean up and remove any extraneous blank lines
	var trimmedResults = $.map( $('#orderedRaceResults').val().split('\n'), function(val){
		return val === "" ? null : val;
	});
	
	// Re-fill the textarea with the trimmed data
	$('#orderedRaceResults').val(trimmedResults.join('\n'))
	
	// Get the top 0 to 3 players and auto-fill the top-3 player slots
	for(var i=0; i<Math.min(3,trimmedResults.length); i++){
		$(`#player${i+1}`).val(trimmedResults[i]).change()
	}
})

// Websocket client to get auto-pasted race data
function wsConnect() {
	var ws = new WebSocket(`ws://localhost:${config.databroker.websocketPort}`);
	ws.onopen = function() {
		// Maybe show connection status message in future
	};

	// Handle incoming data
	ws.onmessage = function(msg) {
		console.log('Got data on Websocket');

		// Parse to JSON
		try{
			var parsedData = JSON.parse(msg.data)
		}
		catch(e){
			console.error(`Invalid JSON payload from Websocket: ${msg.data}`)
			return
		}

		$('#orderedRaceResults').val(parsedData.rawResults).change()

		// Send data acknowledgement back
		ws.send(JSON.stringify({messageType: 'dataACK'}))

	};

	ws.onclose = function(e) {
		console.log('Socket is closed. Reconnect will be attempted in 1 second.', e.reason);
		setTimeout(function() {
			wsConnect();
		}, 1000);
	};

	ws.onerror = function(err) {
		console.error('Socket encountered error: ', err.message, 'Closing socket');
		ws.close();
	};
}

// Return false if race number not found, otherwise return airtable record ID for the race
function checkRaceExists(raceNumber) {
	var result = Object.keys(raceList).find(race => parseInt(raceList[race][config.airtable.raceNumberFieldName]) == raceNumber)
	
	if(result === undefined) return false
	return result
}


function getKeyByValue(object, value) {
  return Object.keys(object).find(key => object[key] === value);
}


// Create a new Race record
function createRace() {
	// Lookup record ID for the selected location to link it in the table
	var locationID = locationList[$('#raceLocation').val()].recordID

	return new Promise((resolve,reject) => {
		airtableDB(config.airtable.raceTableName).create(
			[
				{
					'fields':{
						[config.airtable.raceSeasonFieldName]: config.lfg.season,
						[config.airtable.raceWeekFieldName]: config.lfg.week,
						[config.airtable.raceNumberFieldName]: $('#raceInput').val(),
						[config.airtable.raceLocationFieldName]: [locationID]
					}
				}
			],
			{typecast: true},
			function(err, records){
				if(err) {
					console.error(err);
					reject(err);
					return
				}
				
				// Save the record ID we just created to link the results to this race below
				raceRecordID = records[0].getId();
				console.log(`Race Created. New Race Record ID: ${raceRecordID}`);

				resolve(raceRecordID);
			}
		);
	});
}


function insertRawResults(raceRecordID, raceResultsRaw, raceFinishers) {
	// Insert the data into the Results table

	return new Promise((resolve, reject) => {
		airtableDB(config.airtable.resultsTableName).create(
			[
				{
					'fields':{
						[config.airtable.resultsRaceLinkedFieldName]: [raceRecordID],
						[config.airtable.resultsRawFieldName]: raceResultsRaw,
						[config.airtable.resultsFinishersFieldName]: raceFinishers 
					}
				}
			],
			function(err, records){
				if(err) {
					console.error(err);
					reject(err);
					return;
				}
				
				console.log(`Race ID ${raceRecordID} Saved`)
				/*records.forEach(function (record) {
					console.log(record.getId());
				})*/

				resolve();
			}
		);
	});
}

// Save raw results list to database.  Triggered by form save button.
function saveRaceRaw(){

	// Check if Race already exists in Race table.  If not, then we need to create it
	var raceRecordID = checkRaceExists($('#raceInput').val())
	var resultsRaw = $('#orderedRaceResults').val()
	var raceFinishers = parseInt($('#lastPlaceInput').val())

	if(raceRecordID === false){
		newRace = createRace();
		newRace.then(function(raceRecordID){
			insertRawResults(raceRecordID,resultsRaw,raceFinishers)
		});
	}
	else{
		insertRawResults(raceRecordID,resultsRaw,raceFinishers)
	}
}

// Setup data refresh from Airtable every 15 seconds with an immediate refresh to start
loadPlayers()
var airtablePlayerRefreshTimer = setInterval(loadPlayers, 15000);

// Race data doesn't need to update as often
loadRaces(true)
var airtableRaceRefreshTimer = setInterval(loadRaces, 30000);

loadLocations()

$('#season').append(`Season: ${config.lfg.season}`)
$('#week').append(`Week: ${config.lfg.week}`)

// Setup websocket connection to marblescopier-listener databroker
wsConnect();

</script>


</html>